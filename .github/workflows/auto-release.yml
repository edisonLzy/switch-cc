name: Auto Release on Master

on:
  push:
    branches: [ master, main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '.gitignore'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ›å»ºæ–°ç‰ˆæœ¬
  check-version:
    name: Check Version
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.version-check.outputs.should-release }}
      new-version: ${{ steps.version-check.outputs.new-version }}
      version-changed: ${{ steps.version-check.outputs.version-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: current-version
        run: |
          VERSION=$(grep '"version"' package.json | head -1 | sed 's/.*"version": *"\([^"]*\)".*/\1/')
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Current version: ${VERSION}"

      - name: Check if tag exists
        id: tag-check
        run: |
          TAG="v${{ steps.current-version.outputs.version }}"
          if git tag -l | grep -q "^${TAG}$"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Tag ${TAG} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Tag ${TAG} does not exist"
          fi

      - name: Check version changes
        id: version-check
        run: |
          CURRENT_VERSION="${{ steps.current-version.outputs.version }}"
          TAG_EXISTS="${{ steps.tag-check.outputs.exists }}"
          
          if [ "${TAG_EXISTS}" = "false" ]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "new-version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
            echo "version-changed=true" >> $GITHUB_OUTPUT
            echo "âœ… å°†åˆ›å»ºæ–°ç‰ˆæœ¬: v${CURRENT_VERSION}"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "new-version=" >> $GITHUB_OUTPUT  
            echo "version-changed=false" >> $GITHUB_OUTPUT
            echo "âŒ ç‰ˆæœ¬ v${CURRENT_VERSION} å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
          fi

  # åˆ›å»ºGitæ ‡ç­¾
  create-tag:
    name: Create Tag
    needs: check-version
    if: needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create and push tag
        run: |
          TAG="v${{ needs.check-version.outputs.new-version }}"
          echo "Creating tag: ${TAG}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git tag -a "${TAG}" -m "Release ${TAG}"
          git push origin "${TAG}"
          
          echo "âœ… Tag ${TAG} created and pushed"

  # æ„å»ºå’Œå‘å¸ƒ
  build-release:
    name: Build and Release
    needs: [check-version, create-tag]
    if: needs.check-version.outputs.should-release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
            target: 'universal-apple-darwin'
          - platform: 'ubuntu-22.04'  
            args: '--target x86_64-unknown-linux-gnu'
            target: 'x86_64-unknown-linux-gnu'
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            target: 'x86_64-pc-windows-msvc'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: v${{ needs.check-version.outputs.new-version }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Linuxç³»ç»Ÿä¾èµ–
      - name: Install GTK and related libraries
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            pkg-config \
            libglib2.0-dev \
            libgobject-introspection1.0-dev \
            libgirepository1.0-dev \
            libgdk-pixbuf-2.0-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      - name: Set comprehensive PKG_CONFIG_PATH
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/lib/pkgconfig" >> $GITHUB_ENV
          
      - name: Verify pkg-config setup
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          echo "ğŸ” Verifying pkg-config libraries..."
          pkg-config --exists glib-2.0 && echo "âœ… glib-2.0 found" || echo "âŒ glib-2.0 missing"
          pkg-config --exists gobject-2.0 && echo "âœ… gobject-2.0 found" || echo "âŒ gobject-2.0 missing"
          pkg-config --exists gio-2.0 && echo "âœ… gio-2.0 found" || echo "âŒ gio-2.0 missing"
          pkg-config --exists gtk+-3.0 && echo "âœ… gtk+-3.0 found" || echo "âŒ gtk+-3.0 missing"
          echo "ğŸ“‹ PKG_CONFIG_PATH: $PKG_CONFIG_PATH"

      # æ„å»ºå‰ç«¯
      - name: Build frontend
        run: pnpm build:renderer

      # ä½¿ç”¨Tauri Actionæ„å»ºå’Œå‘å¸ƒ
      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v${{ needs.check-version.outputs.new-version }}
          releaseName: 'Switch CC v${{ needs.check-version.outputs.new-version }}'
          releaseBody: |
            ## Switch CC v${{ needs.check-version.outputs.new-version }}
            
            ğŸ‰ **è‡ªåŠ¨å‘å¸ƒç‰ˆæœ¬** - åˆå¹¶åˆ°masteråˆ†æ”¯æ—¶è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
            
            ### ğŸ“¦ ä¸‹è½½å®‰è£…
            
            | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **macOS** | `*.dmg` | æ”¯æŒIntelå’ŒApple Silicon |
            | **Windows** | `*.exe` | Windows 10/11 x64 |
            | **Linux** | `*.AppImage` / `*.deb` | Ubuntu 22.04+ |
            
            ### ğŸš€ ä¸»è¦åŠŸèƒ½
            - âœ¨ æ™ºèƒ½çš„Claudeé…ç½®ä¾›åº”å•†ç®¡ç†
            - ğŸ”„ ä¸€é”®åˆ‡æ¢ä¸åŒAPIä¾›åº”å•†  
            - ğŸ“± MenuBarå¿«é€Ÿè®¿é—®æ¨¡å¼
            - ğŸ›¡ï¸ å®‰å…¨çš„é…ç½®åˆå¹¶ç­–ç•¥
            - âš¡ å¤šç•Œé¢å®æ—¶åŒæ­¥
            - ğŸ¨ ç°ä»£åŒ–Neobrutalismè®¾è®¡
            
            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            2. å®‰è£…å¹¶å¯åŠ¨åº”ç”¨
            3. æ·»åŠ æ‚¨çš„Claude APIä¾›åº”å•†é…ç½®
            4. åœ¨MenuBaræˆ–ä¸»ç•Œé¢å¿«é€Ÿåˆ‡æ¢
            
            ### ğŸ“‹ æ›´æ–°å†…å®¹
            
            æœ¬ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼ŒåŒ…å«æœ€æ–°çš„ä»£ç æ›´æ”¹å’ŒåŠŸèƒ½æ”¹è¿›ã€‚
            
            è¯¦ç»†æ›´æ–°æ—¥å¿—è¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/edisonLzy/switch-cc/blob/master/CHANGELOG.md)ã€‚
            
            ---
            
            å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ [Issue](https://github.com/edisonLzy/switch-cc/issues)ã€‚
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

  # å‘å¸ƒæˆåŠŸåçš„å¤„ç†
  post-release:
    name: Post Release Tasks  
    needs: [check-version, build-release]
    if: success() && needs.check-version.outputs.should-release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update documentation
        run: |
          VERSION="${{ needs.check-version.outputs.new-version }}"
          DATE=$(date +'%Y-%m-%d')
          
          # æ›´æ–°CHANGELOG
          echo "## v${VERSION} - ${DATE}" > CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          echo "### ğŸ‰ è‡ªåŠ¨å‘å¸ƒ" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          echo "- ğŸ“¦ å¤šå¹³å°æ„å»ºäº§ç‰©è‡ªåŠ¨ç”Ÿæˆ" >> CHANGELOG_NEW.md  
          echo "- ğŸš€ åŸºäºmasteråˆ†æ”¯æœ€æ–°ä»£ç æ„å»º" >> CHANGELOG_NEW.md
          echo "- âœ… é€šè¿‡GitHub Actionsè‡ªåŠ¨åŒ–æµç¨‹" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          
          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> CHANGELOG_NEW.md
          fi
          mv CHANGELOG_NEW.md CHANGELOG.md
          
          # æäº¤æ›´æ–°
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git commit -m "ğŸ“ Update CHANGELOG for v${VERSION}" || exit 0
          git push || exit 0

      - name: Release Summary
        run: |
          VERSION="${{ needs.check-version.outputs.new-version }}"
          echo "ğŸ‰ Switch CC v${VERSION} å‘å¸ƒå®Œæˆï¼"
          echo ""
          echo "ğŸ“Š å‘å¸ƒæ‘˜è¦:"
          echo "  â€¢ ç‰ˆæœ¬: v${VERSION}"
          echo "  â€¢ æ„å»ºæ—¶é—´: $(date)"
          echo "  â€¢ è§¦å‘æ–¹å¼: æ¨é€åˆ°masteråˆ†æ”¯"
          echo "  â€¢ æ„å»ºå¹³å°: macOS, Windows, Linux"
          echo ""
          echo "ğŸ”— ä¸‹è½½åœ°å€:"
          echo "  https://github.com/edisonLzy/switch-cc/releases/tag/v${VERSION}"
          echo ""
          echo "âœ… æ‰€æœ‰æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ°GitHub Release"