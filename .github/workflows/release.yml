name: Release Build and Publish

on:
  push:
    branches: [ master, main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master, main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # æ£€æŸ¥å’Œæµ‹è¯•é˜¶æ®µ
  check:
    name: Check and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: TypeScript type check
        run: pnpm typecheck

      - name: Format check
        run: pnpm format:check

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust check
        run: cargo check --manifest-path=src-tauri/Cargo.toml

      - name: Rust format check
        run: cargo fmt --manifest-path=src-tauri/Cargo.toml --all -- --check

      - name: Rust clippy
        run: cargo clippy --manifest-path=src-tauri/Cargo.toml --all-targets --all-features -- -D warnings

  # æ„å»ºé˜¶æ®µ - å¤šå¹³å°å¹¶è¡Œæ„å»º
  build:
    name: Build Application
    needs: check
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target universal-apple-darwin'
            target: 'universal-apple-darwin'
            arch: 'universal'
          - platform: 'ubuntu-22.04'
            args: '--target x86_64-unknown-linux-gnu'
            target: 'x86_64-unknown-linux-gnu'  
            arch: 'amd64'
          - platform: 'windows-latest'
            args: '--target x86_64-pc-windows-msvc'
            target: 'x86_64-pc-windows-msvc'
            arch: 'x64'

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Linuxä¸“ç”¨ï¼šå®‰è£…ç³»ç»Ÿä¾èµ–
      - name: Install GTK and related libraries
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libglib2.0-dev \
            pkg-config

      - name: Set PKG_CONFIG_PATH
        if: matrix.platform == 'ubuntu-22.04'
        run: echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig" >> $GITHUB_ENV

      # macOSä¸“ç”¨ï¼šå®‰è£…Apple Developerè¯ä¹¦ï¼ˆå¦‚æœéœ€è¦ä»£ç ç­¾åï¼‰
      - name: Setup macOS keychain
        if: matrix.platform == 'macos-latest' && env.APPLE_CERTIFICATE
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P $APPLE_CERTIFICATE_PASSWORD -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          rm certificate.p12

      - name: Build frontend
        run: pnpm build:renderer

      - name: Build Tauri application
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # ä»£ç ç­¾åç¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: v__VERSION__
          releaseName: 'Switch CC v__VERSION__'
          releaseBody: |
            ## Switch CC v__VERSION__
            
            ### ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ
            
            Switch CC æ˜¯ä¸€ä¸ªä¸“æ³¨äº Claude Code é…ç½®ç®¡ç†å’Œå¿«é€Ÿåˆ‡æ¢çš„æ¡Œé¢åº”ç”¨ã€‚
            
            ### ğŸ“¦ æ”¯æŒå¹³å°
            - **macOS**: Universal Binary (Intel + Apple Silicon)
            - **Windows**: x64 
            - **Linux**: x64 (Ubuntu 22.04+)
            
            ### ğŸš€ æ ¸å¿ƒåŠŸèƒ½
            - ğŸ”„ æ™ºèƒ½ä¾›åº”å•†åˆ‡æ¢
            - ğŸ“± MenuBarå¿«é€Ÿè®¿é—®  
            - ğŸ›¡ï¸ é…ç½®å®‰å…¨åˆå¹¶
            - ğŸ¨ Neobrutalismç•Œé¢è®¾è®¡
            - âš¡ å¤šç•Œé¢å®æ—¶åŒæ­¥
            
            ### ğŸ“‹ å®‰è£…è¯´æ˜
            
            #### macOS
            1. ä¸‹è½½ `Switch-CC_*_universal-apple-darwin.dmg`
            2. åŒå‡»æ‰“å¼€ï¼Œæ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
            3. é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
            
            #### Windows  
            1. ä¸‹è½½ `Switch-CC_*_x64-setup.exe`
            2. å³é”®ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œå®‰è£…ç¨‹åº
            3. æŒ‰ç…§å‘å¯¼å®Œæˆå®‰è£…
            
            #### Linux
            1. ä¸‹è½½ `switch-cc_*_amd64.AppImage` æˆ– `switch-cc_*_amd64.deb`
            2. AppImage: æ·»åŠ æ‰§è¡Œæƒé™åç›´æ¥è¿è¡Œ
            3. DEB: `sudo dpkg -i switch-cc_*_amd64.deb`
            
            ### ğŸ”§ æŠ€æœ¯æ ˆ
            - **å‰ç«¯**: React 18 + TypeScript + Tailwind CSS 4
            - **åç«¯**: Rust + Tauri 2.8
            - **æ„å»º**: Vite + pnpm
            
            ---
            
            **å®Œæ•´æ›´æ–°æ—¥å¿—**: [æŸ¥çœ‹CHANGELOG.md](https://github.com/edisonLzy/switch-cc/blob/master/CHANGELOG.md)
            
            å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ [Issue](https://github.com/edisonLzy/switch-cc/issues)ã€‚
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}

  # å‘å¸ƒå®Œæˆåçš„æ¸…ç†å’Œé€šçŸ¥
  post-release:
    name: Post Release
    needs: build
    if: success() && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release info
        id: release_info
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG
        run: |
          echo "## Version ${{ steps.release_info.outputs.version }} - $(date +'%Y-%m-%d')" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md  
          echo "- ğŸ‰ Release build for version ${{ steps.release_info.outputs.version }}" >> CHANGELOG_NEW.md
          echo "- ğŸ“¦ Multi-platform binaries available" >> CHANGELOG_NEW.md
          echo "- ğŸš€ Automated build and release process" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> CHANGELOG_NEW.md
          fi
          mv CHANGELOG_NEW.md CHANGELOG.md

      # å¯é€‰ï¼šå‘é€é€šçŸ¥åˆ°Slack/Discordç­‰
      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Switch CC v${{ steps.release_info.outputs.version }} å‘å¸ƒæˆåŠŸï¼"
          echo "ğŸ“¦ å¤šå¹³å°æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Release"
          echo "ğŸ”— Release URL: https://github.com/edisonLzy/switch-cc/releases/tag/${{ steps.release_info.outputs.tag }}"