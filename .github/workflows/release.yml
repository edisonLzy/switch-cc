# macOS åº”ç”¨æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ
# ç”¨äºæ„å»º Tauri æ¡Œé¢åº”ç”¨å¹¶å‘å¸ƒåˆ° GitHub Releasesï¼Œé€‚ç”¨äºå¼€å‘è€…åˆ†å‘
name: Build and Release macOS App

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° master åˆ†æ”¯æˆ–æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [master]
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œæ–¹ä¾¿å¼€å‘è€…æŒ‰éœ€æ„å»º
  workflow_dispatch:

# æƒé™é…ç½® - å…è®¸å·¥ä½œæµè¿›è¡Œå¿…è¦çš„æ“ä½œ
permissions:
  contents: write    # å…è®¸åˆ›å»º releases å’Œæ¨é€åˆ°ä»“åº“

# ç¯å¢ƒå˜é‡é…ç½®
env:
  # å¯ç”¨å½©è‰²è¾“å‡ºï¼Œä¾¿äºæŸ¥çœ‹æ„å»ºæ—¥å¿—
  FORCE_COLOR: 1
  # Node.js ç‰ˆæœ¬
  NODE_VERSION: '18'

jobs:
  build-macos:
    name: Build macOS Application
    runs-on: macos-latest

    steps:
      # 1. ä»£ç æ£€å‡º - è·å–å®Œæ•´çš„ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # è·å–å®Œæ•´çš„ Git å†å²ï¼Œç”¨äºç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
          fetch-depth: 0
          # ä½¿ç”¨ PAT token ä»¥ç»•è¿‡åˆ†æ”¯ä¿æŠ¤è§„åˆ™
          # å¦‚æœæ²¡æœ‰é…ç½® PAT_TOKENï¼Œåˆ™ä½¿ç”¨é»˜è®¤çš„ GITHUB_TOKEN
          token: ${{ secrets.PAT_TOKEN || github.token }}

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      # Tauri å‰ç«¯éœ€è¦ Node.js æ¥æ„å»º React + Vite é¡¹ç›®
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          # ä½¿ç”¨å®˜æ–¹ npm æ³¨å†Œè¡¨
          registry-url: 'https://registry.npmjs.org'

      # 3. è®¾ç½® pnpm åŒ…ç®¡ç†å™¨ï¼ˆä½¿ç”¨å®˜æ–¹ Actionï¼Œé¿å…ç»ç”± npm å®‰è£…ï¼‰
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      # 4. è·å– pnpm ç¼“å­˜ç›®å½•
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # 5. ç¼“å­˜ pnpm ä¾èµ–
      # ç¼“å­˜æœºåˆ¶å¯ä»¥æ˜¾è‘—åŠ é€Ÿæ„å»ºè¿‡ç¨‹
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 6. å®‰è£… Rust å·¥å…·é“¾
      # Tauri åç«¯ä½¿ç”¨ Rust ç¼–å†™ï¼Œéœ€è¦ Rust ç¼–è¯‘å™¨
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          # å®‰è£…ç¨³å®šç‰ˆ Rust
          toolchain: stable
          # macOS æ„å»ºç›®æ ‡
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      # 7. ç¼“å­˜ Rust ä¾èµ–
      # Rust ç¼–è¯‘æ—¶é—´è¾ƒé•¿ï¼Œç¼“å­˜å¯ä»¥æ˜¾è‘—æå‡æ„å»ºé€Ÿåº¦
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          # ç¼“å­˜ Cargo æ„å»ºäº§ç‰©
          workspaces: src-tauri

      # 8. å®‰è£…å‰ç«¯ä¾èµ–
      # å®‰è£… Reactã€Vite ç­‰å‰ç«¯æ„å»ºä¾èµ–
      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      # 9. è‡ªåŠ¨ç‰ˆæœ¬æ›´æ–°
      # æ ¹æ® commit æ¶ˆæ¯è‡ªåŠ¨ç¡®å®šç‰ˆæœ¬æ›´æ–°ç±»å‹å¹¶æ›´æ–°é…ç½®æ–‡ä»¶
      - name: Auto version bump
        id: version_bump
        run: |
          echo "å¼€å§‹ç‰ˆæœ¬æ£€æµ‹å’Œæ›´æ–°..."

          # è·å–å½“å‰ç‰ˆæœ¬å·ï¼ˆä» package.jsonï¼‰
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          # è·å–æœ€æ–°çš„ commit æ¶ˆæ¯
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit æ¶ˆæ¯: $COMMIT_MSG"

          # ç‰ˆæœ¬æ›´æ–°é€»è¾‘
          if [[ "$COMMIT_MSG" =~ ^feat(\(.+\))?!: ]] || [[ "$COMMIT_MSG" =~ BREAKING[[:space:]]CHANGE ]]; then
            # Major ç‰ˆæœ¬æ›´æ–°ï¼šfeat!: æˆ–åŒ…å« BREAKING CHANGE
            VERSION_TYPE="major"
            echo "æ£€æµ‹åˆ° BREAKING CHANGEï¼Œæ‰§è¡Œ major ç‰ˆæœ¬æ›´æ–°"
          elif [[ "$COMMIT_MSG" =~ ^feat(\(.+\))?: ]]; then
            # Minor ç‰ˆæœ¬æ›´æ–°ï¼šfeat:
            VERSION_TYPE="minor"
            echo "æ£€æµ‹åˆ°æ–°åŠŸèƒ½ï¼Œæ‰§è¡Œ minor ç‰ˆæœ¬æ›´æ–°"
          elif [[ "$COMMIT_MSG" =~ ^fix(\(.+\))?: ]]; then
            # Patch ç‰ˆæœ¬æ›´æ–°ï¼šfix:
            VERSION_TYPE="patch"
            echo "æ£€æµ‹åˆ°ä¿®å¤ï¼Œæ‰§è¡Œ patch ç‰ˆæœ¬æ›´æ–°"
          else
            # é»˜è®¤ patch ç‰ˆæœ¬æ›´æ–°
            VERSION_TYPE="patch"
            echo "å…¶ä»–æäº¤ç±»å‹ï¼Œæ‰§è¡Œ patch ç‰ˆæœ¬æ›´æ–°"
          fi

          # è®¡ç®—æ–°ç‰ˆæœ¬å·
          IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
          MAJOR=${VERSION_PARTS[0]}
          MINOR=${VERSION_PARTS[1]}
          PATCH=${VERSION_PARTS[2]}

          case $VERSION_TYPE in
            "major")
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            "minor")
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            "patch")
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "æ–°ç‰ˆæœ¬å·: $NEW_VERSION"

          # æ›´æ–° package.json
          echo "æ›´æ–° package.json ç‰ˆæœ¬..."
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$NEW_VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

          # æ›´æ–° src-tauri/tauri.conf.json
          echo "æ›´æ–° tauri.conf.json ç‰ˆæœ¬..."
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            config.version = '$NEW_VERSION';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(config, null, 2) + '\n');
          "

          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "old_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          echo "âœ… ç‰ˆæœ¬æ›´æ–°å®Œæˆ: $CURRENT_VERSION â†’ $NEW_VERSION ($VERSION_TYPE)"

      # 10. æ„å»º Tauri åº”ç”¨
      # è¿™æ˜¯æ ¸å¿ƒæ­¥éª¤ï¼šæ„å»ºå‰ç«¯ + åç«¯å¹¶æ‰“åŒ…æˆ macOS åº”ç”¨
      - name: Build Tauri application
        run: |
          echo "å¼€å§‹æ„å»º Tauri åº”ç”¨..."
          # é¦–å…ˆæ„å»ºå‰ç«¯
          echo "æ„å»ºå‰ç«¯..."
          pnpm build:renderer

          # ç„¶åæ„å»º Tauri åº”ç”¨
          echo "æ„å»º Tauri åç«¯å¹¶æ‰“åŒ…..."
          pnpm tauri build --verbose
        env:
          # ä½¿ç”¨ ad-hoc ç­¾åï¼Œé€‚ç”¨äºå¼€å‘è€…åˆ†å‘
          # é€šè¿‡ tauri.conf.json ä¸­çš„ signingIdentity: "-" é…ç½®
          # ç¡®ä¿æ„å»ºç›®æ ‡åŒ…å« Apple Silicon å’Œ Intel æ¶æ„
          TAURI_BUILD_TARGETS: "universal-apple-darwin"

      # 11. æŸ¥æ‰¾æ„å»ºäº§ç‰©
      # æ„å»ºå®Œæˆåï¼Œéœ€è¦æ‰¾åˆ°ç”Ÿæˆçš„ .app å’Œ .dmg æ–‡ä»¶
      - name: Find build artifacts
        id: find_artifacts
        run: |
          echo "æŸ¥æ‰¾æ„å»ºäº§ç‰©..."

          # æŸ¥æ‰¾ .app æ–‡ä»¶
          APP_PATH=$(find src-tauri/target/release/bundle/macos -name "*.app" -type d | head -1)
          echo "æ‰¾åˆ° .app æ–‡ä»¶: $APP_PATH"
          echo "app_path=$APP_PATH" >> $GITHUB_OUTPUT

          # æŸ¥æ‰¾ .dmg æ–‡ä»¶
          DMG_PATH=$(find src-tauri/target/release/bundle/dmg -name "*.dmg" | head -1)
          echo "æ‰¾åˆ° .dmg æ–‡ä»¶: $DMG_PATH"
          echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT

          # è·å–åº”ç”¨åç§°ï¼ˆä» .app è·¯å¾„æå–ï¼‰
          APP_NAME=$(basename "$APP_PATH" .app)
          echo "åº”ç”¨åç§°: $APP_NAME"
          echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT

      # 12. åˆ›å»ºåº”ç”¨å‹ç¼©åŒ…
      # ä¸º .app æ–‡ä»¶åˆ›å»ºå‹ç¼©åŒ…ï¼Œä½œä¸ºå¤‡ç”¨åˆ†å‘æ ¼å¼
      - name: Create app archive
        run: |
          echo "åˆ›å»ºåº”ç”¨å‹ç¼©åŒ…..."
          cd "$(dirname "${{ steps.find_artifacts.outputs.app_path }}")"
          tar -czf "${{ steps.find_artifacts.outputs.app_name }}.app.tar.gz" "${{ steps.find_artifacts.outputs.app_name }}.app"
          echo "å‹ç¼©åŒ…å·²åˆ›å»º: $PWD/${{ steps.find_artifacts.outputs.app_name }}.app.tar.gz"

      # 13. æäº¤ç‰ˆæœ¬æ›´æ–°
      # å°†ç‰ˆæœ¬æ›´æ–°æäº¤å›ä»“åº“ï¼Œä¿æŒç‰ˆæœ¬åŒæ­¥
      - name: Commit version bump
        run: |
          echo "æäº¤ç‰ˆæœ¬æ›´æ–°åˆ°ä»“åº“..."
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # æ·»åŠ å’Œæäº¤æ›´æ”¹
          git add package.json src-tauri/tauri.conf.json
          git commit -m "chore(release): bump version to ${{ steps.version_bump.outputs.new_version }} [skip ci]" || echo "No changes to commit"

          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          # æ³¨æ„ï¼šè¿™é‡Œä¼šä½¿ç”¨ checkout æ—¶é…ç½®çš„ token
          git push origin HEAD:master || echo "Push failed - this is expected if branch protection is enabled"
        env:
          # ä½¿ç”¨ä¸ checkout ç›¸åŒçš„ token
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN || github.token }}

      # 14. åˆ›å»º GitHub Release
      # è‡ªåŠ¨åˆ›å»º Release å¹¶ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
          tag_name: "v${{ steps.version_bump.outputs.new_version }}"
          name: "Switch CC v${{ steps.version_bump.outputs.new_version }}"
          # ç”Ÿæˆ Release Notes
          body: |
            ## Switch CC macOS ç‰ˆæœ¬å‘å¸ƒ

            **ç‰ˆæœ¬ä¿¡æ¯:**
            - ç‰ˆæœ¬å·: v${{ steps.version_bump.outputs.new_version }}
            - ç‰ˆæœ¬ç±»å‹: ${{ steps.version_bump.outputs.version_type }} (ä» v${{ steps.version_bump.outputs.old_version }} å‡çº§)
            - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
            - æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}
            - æäº¤å“ˆå¸Œ: ${{ github.sha }}

            **macOS å®‰è£…è¯´æ˜:**
            1. ä¸‹è½½ `.dmg` æ–‡ä»¶ï¼ˆæ¨èï¼‰
            2. åŒå‡»æŒ‚è½½ç£ç›˜é•œåƒ
            3. å°† Switch CC åº”ç”¨æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
            4. **é‡è¦**: é¦–æ¬¡è¿è¡Œæ—¶è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
               - åœ¨ Applications æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ° Switch CC
               - **å³é”®ç‚¹å‡»** Switch CC åº”ç”¨
               - é€‰æ‹© **"æ‰“å¼€"**
               - åœ¨å®‰å…¨è­¦å‘Šå¯¹è¯æ¡†ä¸­ç‚¹å‡» **"æ‰“å¼€"**
               - ä¹‹åå¯ä»¥æ­£å¸¸åŒå‡»å¯åŠ¨

            **å¦‚æœé‡åˆ°"å·²æŸå"é”™è¯¯:**
            - è¯¥é”™è¯¯é€šå¸¸æ˜¯ç”±äº macOS Gatekeeper çš„å®‰å…¨æ£€æŸ¥
            - è¯·ä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°å³é”®"æ‰“å¼€"çš„æ–¹å¼é¦–æ¬¡å¯åŠ¨
            - é¦–æ¬¡æˆåŠŸè¿è¡Œåï¼Œåç»­å¯æ­£å¸¸åŒå‡»å¯åŠ¨

            **å¤‡ç”¨å®‰è£…æ–¹å¼:**
            - å¦‚æœ `.dmg` æ–‡ä»¶æ— æ³•ä½¿ç”¨ï¼Œå¯ä¸‹è½½ `.app.tar.gz` å‹ç¼©åŒ…
            - è§£å‹åå°† `.app` æ–‡ä»¶æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
            - åŒæ ·éœ€è¦å³é”®"æ‰“å¼€"è¿›è¡Œé¦–æ¬¡å¯åŠ¨

            **æŠ€æœ¯è¯´æ˜:**
            - æ­¤ç‰ˆæœ¬ä½¿ç”¨ ad-hoc ç­¾åï¼Œç¬¦åˆ macOS å®‰å…¨è¦æ±‚
            - ä¸ä¼šæ˜¾ç¤º"å·²æŸå"é”™è¯¯ï¼Œä½†éœ€è¦æ‰‹åŠ¨ç¡®è®¤é¦–æ¬¡è¿è¡Œ
            - é€‚ç”¨äºå¼€å‘è€…åˆ†å‘å’Œæµ‹è¯•ä½¿ç”¨
          # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          prerelease: false
          # ä¸Šä¼ æ„å»ºäº§ç‰©
          files: |
            ${{ steps.find_artifacts.outputs.dmg_path }}
            $(dirname "${{ steps.find_artifacts.outputs.app_path }}")/${{ steps.find_artifacts.outputs.app_name }}.app.tar.gz
        env:
          # ä½¿ç”¨ GitHub Token è¿›è¡Œè®¤è¯
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 15. æ„å»ºå®Œæˆé€šçŸ¥
      - name: Build completed
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "  - ç‰ˆæœ¬æ›´æ–°: v${{ steps.version_bump.outputs.old_version }} â†’ v${{ steps.version_bump.outputs.new_version }} (${{ steps.version_bump.outputs.version_type }})"
          echo "ğŸ“¦ ç”Ÿæˆçš„äº§ç‰©:"
          echo "  - DMG å®‰è£…åŒ…: ${{ steps.find_artifacts.outputs.dmg_path }}"
          echo "  - APP å‹ç¼©åŒ…: ${{ steps.find_artifacts.outputs.app_name }}.app.tar.gz"
          echo "ğŸš€ Release å·²åˆ›å»º: v${{ steps.version_bump.outputs.new_version }}"